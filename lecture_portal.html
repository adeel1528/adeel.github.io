<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease-in-out;
            /* Subtle grid pattern */
            background-image:
                linear-gradient(to right, rgba(255, 255, 255, 0.07) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.07) 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        body.dark {
            background-color: #1e293b; /* Slate 900 */
        }
        body.light {
            background-color: #f1f5f9; /* Slate 100 */
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Card Hover Effects */
        .card-hover { transition: all 0.3s ease-in-out; }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            filter: brightness(1.1);
        }

        /* --- UPDATED MODAL & VIDEO STYLES FOR MOBILE --- */
        
        /* Fix for Modal Scrolling on Mobile */
        #lecture-view-modal {
            position: fixed;
            inset: 0;
            z-index: 50;
            overflow-y: auto; /* Allows scrolling if modal is too tall */
            background-color: rgba(30, 41, 59, 0.9); /* Darker backdrop */
            backdrop-filter: blur(4px);
        }

        /* Wrapper to center modal but allow scrolling */
        .modal-scroll-wrapper {
            display: flex;
            min-height: 100%;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        /* Video Container - 16:9 Aspect Ratio */
        #lecture-video-player-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background: #000;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        #lecture-video-player-container iframe,
        #lecture-video-player-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        audio {
            width: 100%;
            border-radius: 10px;
            background-color: #475569;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            outline: none;
        }

        /* Main App Container Glow */
        #app {
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            flex: 1;
        }
        body.dark #app {
            background-color: #475569;
            box-shadow: 0 0 20px rgba(252, 211, 77, 0.4), 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        body.light #app {
            background-color: #ffffff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1), 0 10px 20px rgba(0, 0, 0, 0.05);
        }
        
        /* Animations */
        .section-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .active-breadcrumb {
            background-color: #f59e0b !important;
            color: #ffffff !important;
            font-weight: 700;
        }

        /* Search Bar Glow */
        #lecture-search-input { transition: all 0.3s ease-in-out; }
        body.dark #lecture-search-input {
            border-color: #f59e0b;
            box-shadow: 0 0 8px rgba(252, 211, 77, 0.4);
        }
        #lecture-search-input:focus { animation: glowing-border 1.8s infinite; }
        @keyframes glowing-border {
            0% { box-shadow: 0 0 8px rgba(252, 211, 77, 0.4); }
            50% { box-shadow: 0 0 20px rgba(252, 211, 77, 0.8); }
            100% { box-shadow: 0 0 8px rgba(252, 211, 77, 0.4); }
        }

        /* Card Colors */
        .card-class, .card-teacher, .card-subject, .card-lecture { transition: background-color 0.3s, border-color 0.3s; }

        /* Dark Mode */
        body.dark .card-class { background-color: #1a425a; border-color: #2b709e; }
        body.dark .card-teacher { background-color: #472b1d; border-color: #8c4e36; }
        body.dark .card-subject { background-color: #3b3a1a; border-color: #6d6b2f; }
        body.dark .card-lecture { background-color: #2b1d40; border-color: #5a3c7c; }

        /* Light Mode */
        body.light .card-class { background-color: #e2f2ff; border-color: #90c2f0; }
        body.light .card-teacher { background-color: #fff0e0; border-color: #ffb880; }
        body.light .card-subject { background-color: #eafce5; border-color: #a3d995; }
        body.light .card-lecture { background-color: #f3e6ff; border-color: #c9a7e0; }
        
        /* Light Mode Text Overrides */
        body.light #app { background-color: #ffffff; }
        body.light .text-white { color: #1e293b; }
        body.light .text-slate-300 { color: #334155; }
        body.light .text-slate-200 { color: #475569; }
        body.light .bg-slate-600 { background-color: #f1f5f9; }
        body.light .bg-slate-500 { background-color: #cbd5e1; }
        body.light #lecture-search-input { background-color: #cbd5e1; color: #1e293b; }
        body.light #lecture-search-input::placeholder { color: #64748b; }
        body.light .bg-slate-700 { background-color: #e2e8f0; }
        body.light .border-slate-500 { border-color: #e2e8f0; }
        body.light .border-amber-300 { border-color: #f59e0b; }
        body.light .text-slate-400 { color: #64748b; }
        body.light .text-slate-500 { color: #94a3b8; }
        body.light .text-blue-600 { color: #2563eb; }
        body.light .text-green-600 { color: #16a34a; }
        body.light .bg-slate-800 { background-color: #94a3b8; }
        body.light .bg-amber-100 { background-color: #fffbeb; }
        body.light .bg-slate-900 { background-color: #e2e8f0; }

        .sun-icon { display: none; }
        .moon-icon { display: block; }
        body.light .sun-icon { display: block; }
        body.light .moon-icon { display: none; }

        .btn-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        
        /* Book Icon Animation */
        .book-icon { transition: transform 0.3s ease-in-out; }
        .card-lecture:hover .book-icon { transform: scale(1.1) rotate(-5deg); }
        
        /* Min Heights for Cards */
        .class-card-min-h { min-height: 180px; }
        .teacher-card-min-h { min-height: 280px; }
        .subject-card-min-h { min-height: 180px; }
        .lecture-card-min-h { min-height: 120px; }

        /* Toast Notification */
        #toast-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
        }
        .toast {
            background: rgba(30, 41, 59, 0.9); color: white; padding: 12px 24px; border-radius: 8px;
            margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 4px solid #f59e0b;
            animation: slideInRight 0.3s ease-out forwards;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .highlight-text { background-color: rgba(245, 158, 11, 0.3); color: white; border-radius: 2px; padding: 0 2px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 sm:p-4 dark">
    <div class="flex-1 flex items-center justify-center p-2 sm:p-4">
        <div id="app" class="rounded-2xl p-4 sm:p-6 md:p-10 w-full max-w-5xl border border-amber-300 transform transition-all duration-300 ease-in-out relative overflow-hidden">
            
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="absolute top-4 right-4 p-2 rounded-full bg-slate-600 text-white hover:bg-slate-500 transition duration-300 shadow-lg z-10">
                <svg class="moon-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                <svg class="sun-icon w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.788 5.788a.75.75 0 00-1.06-1.06l-1.65 1.65a.75.75 0 001.06 1.06l1.65-1.65zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V18a.75.75 0 01.75-.75zM4.939 17.561a.75.75 0 001.06 1.06l1.65-1.65a.75.75 0 00-1.06-1.06l-1.65 1.65zM2.25 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3a.75.75 0 01-.75-.75zM17.561 19.061a.75.75 0 001.06-1.06l-1.65-1.65a.75.75 0 00-1.06 1.06l1.65 1.65zM21 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM19.061 4.939a.75.75 0 00-1.06 1.06l1.65 1.65a.75.75 0 001.06-1.06l-1.65-1.65z"></path></svg>
            </button>

            <!-- College Logo -->
            <div class="flex justify-center mb-6">
                <img src="https://bgmchurch.org/wp-content/uploads/elementor/thumbs/bgm-bluelogo-qzshc087trea6hnhp0uqc6aifp2s383kxpbmzskp9k.png" alt="College Logo" class="w-28 h-28 rounded-full border-4 border-amber-400 shadow-lg object-cover">
            </div>
    
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-8 text-white">Lecture Portal</h1>
    
            <!-- Navigation/Breadcrumbs -->
            <div class="mb-8 text-slate-300 text-lg flex items-center justify-center flex-wrap gap-2">
                <span id="breadcrumb-home" class="cursor-pointer font-medium hover:text-amber-400 transition duration-300 px-2 py-1 rounded-md bg-slate-600 hover:bg-slate-500">Home</span>
                <span id="breadcrumb-class" class="hidden items-center"> <span class="mx-2 text-slate-500">/</span> <span class="cursor-pointer font-medium hover:text-amber-400 transition duration-300 px-2 py-1 rounded-md bg-slate-600 hover:bg-slate-500"></span></span>
                <span id="breadcrumb-teacher" class="hidden items-center"> <span class="mx-2 text-slate-500">/</span> <span class="cursor-pointer font-medium hover:text-amber-400 transition duration-300 px-2 py-1 rounded-md bg-slate-600 hover:bg-slate-500"></span></span>
                <span id="breadcrumb-subject" class="hidden items-center"> <span class="mx-2 text-slate-500">/</span> <span class="cursor-pointer font-medium hover:text-amber-400 transition duration-300 px-2 py-1 rounded-md bg-slate-600 hover:bg-slate-500"></span></span>
            </div>
    
            <!-- Instructions for URL -->
            <div id="url-instruction" class="bg-amber-100 border-l-4 border-amber-500 text-amber-900 p-4 mb-6 rounded-lg shadow-md">
                <p class="font-bold text-lg">Important: Configure Google Apps Script URL!</p>
                <p class="text-base mt-1">Please replace <code class="bg-amber-200 px-1 rounded-md text-amber-900 font-mono">GOOGLE_APPS_SCRIPT_URL</code> in the JavaScript section of this HTML file with the **actual deployed URL** of your Google Apps Script Web App.</p>
            </div>
    
            <!-- Toast Container -->
            <div id="toast-container"></div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center py-10 text-slate-300">
                <svg class="animate-spin h-10 w-10 text-amber-400 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-lg font-medium">Loading dynamic data from Google Sheet...</p>
            </div>
    
            <!-- Error Message -->
            <div id="error-message" class="hidden text-center py-10 text-red-400 bg-red-900 bg-opacity-30 border-l-4 border-red-700 p-6 rounded-lg shadow-md">
                <p class="font-bold text-xl mb-2">Error loading data!</p>
                <p class="text-base">It seems there was a problem fetching information. Please ensure:</p>
                <ul class="list-disc list-inside text-left mx-auto max-w-sm mt-3">
                    <li>The Google Apps Script is correctly deployed as a "Web App" with "Anyone" access.</li>
                    <li>The <code class="bg-red-800 px-1 rounded-sm font-mono text-red-200">GOOGLE_APPS_SCRIPT_URL</code> in this HTML file is updated.</li>
                </ul>
            </div>
    
            <!-- Section for Classes -->
            <div id="classes-section" class="hidden">
                <h2 class="text-2xl font-semibold text-slate-200 mb-6">Classes</h2>
                <div id="classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>
    
            <!-- Section for Teachers -->
            <div id="teachers-section" class="hidden">
                <h2 class="text-2xl font-semibold text-slate-200 mb-6">Teachers for <span id="current-class-name" class="text-amber-400 font-bold"></span></h2>
                <div id="teachers-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>
            
            <!-- Section for Subjects -->
            <div id="subjects-section" class="hidden">
                <h2 class="text-2xl font-semibold text-slate-200 mb-6">Subjects by <span id="current-teacher-name-for-subjects" class="text-amber-400 font-bold"></span></h2>
                <div id="subjects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>
    
            <!-- Section for Lectures -->
            <div id="lectures-section" class="hidden">
                <h2 class="text-2xl font-semibold text-slate-200 mb-6">Lectures for <span id="current-subject-name" class="text-amber-400 font-bold"></span> by <span id="current-teacher-name" class="text-amber-400 font-bold"></span></h2>
                <div class="mb-6 flex flex-col sm:flex-row gap-3">
                    <input type="text" id="lecture-search-input" placeholder="Lectures search karein..." class="flex-1 p-3 rounded-lg bg-slate-600 text-white placeholder-slate-400 border focus:outline-none">
                    <button id="toggle-favorites-btn" class="bg-slate-700 text-white px-5 py-3 rounded-lg font-semibold hover:bg-slate-600 transition duration-300 shadow-md flex items-center justify-center gap-2 border border-slate-500">
                        <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        <span id="fav-btn-text">Favorites</span>
                    </button>
                    <button id="clear-search-btn" class="bg-slate-500 text-white px-5 py-3 rounded-lg font-semibold hover:bg-slate-600 transition duration-300 shadow-md">Clear Search</button>
                </div>
                <p id="search-result-count" class="text-sm text-slate-400 text-right mt-2"></p>
                <div id="lectures-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>
    
            <!-- Lecture View Modal (Mobile Friendly Updated) -->
            <div id="lecture-view-modal" class="hidden transition-opacity duration-300 ease-out">
                <!-- Scroll Wrapper: This ensures the modal scrolls on small screens -->
                <div class="modal-scroll-wrapper">
                    
                    <!-- Modal Content Card -->
                    <div id="modal-content" class="bg-slate-700 rounded-2xl shadow-2xl p-4 sm:p-8 w-[95%] sm:max-w-2xl transform scale-95 opacity-0 transition-all duration-300 ease-out border border-amber-300 relative">
                        
                        <!-- Header -->
                        <div class="flex justify-between items-start mb-4">
                            <h3 id="lecture-modal-title" class="text-xl sm:text-2xl font-bold text-white pr-4 leading-tight"></h3>
                            <button id="close-modal-btn" class="text-slate-400 hover:text-slate-200 text-3xl font-light leading-none p-1">&times;</button>
                        </div>

                        <!-- Language Selection -->
                        <div class="mb-4 border-t border-slate-600 pt-4">
                            <p class="text-slate-300 mb-2 font-semibold text-sm sm:text-base">Zabaan Muntakhab Karein (Select Language):</p>
                            <div class="flex gap-2 sm:gap-3">
                                <button id="lang-english-btn" class="flex-1 bg-blue-600 text-white py-2 sm:py-3 rounded-lg font-semibold text-sm sm:text-base hover:bg-blue-700 transition shadow-md">English</button>
                                <button id="lang-urdu-btn" class="flex-1 bg-green-600 text-white py-2 sm:py-3 rounded-lg font-semibold text-sm sm:text-base hover:bg-green-700 transition shadow-md">اردو (Urdu)</button>
                            </div>
                        </div>

                        <!-- Video Player Container -->
                        <div id="lecture-video-player-container" class="mb-4 hidden shadow-lg border border-slate-600">
                            <!-- Video/Iframe injected here by JS -->
                        </div>

                        <!-- Audio Player Container -->
                        <div id="lecture-audio-player-container" class="mb-5 hidden">
                            <p class="text-slate-300 mb-2 font-semibold">Lecture Audio:</p>
                            <audio id="lecture-audio-player" controls preload="metadata" class="w-full"></audio>
                        </div>

                        <!-- Action Buttons (View/Download) -->
                        <div class="flex flex-col gap-3 mt-2">
                            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                            <a id="lecture-view-link" href="#" target="_blank" class="flex-1 bg-amber-500 text-white py-3 sm:py-3 rounded-lg text-center font-semibold hover:bg-amber-600 transition shadow-md flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                                View Content
                            </a>
                            <a id="lecture-download-link" href="#" download class="flex-1 bg-amber-600 text-white py-3 sm:py-3 rounded-lg text-center font-semibold hover:bg-amber-700 transition shadow-md flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                Download
                            </a>
                            </div>
                            <button id="lecture-share-btn" class="w-full bg-slate-600 text-white py-3 rounded-lg text-center font-semibold hover:bg-slate-500 transition shadow-md flex items-center justify-center gap-2 border border-slate-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                                Share Lecture
                            </button>
                            <button id="lecture-next-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg text-center font-semibold hover:bg-indigo-700 transition shadow-md flex items-center justify-center gap-2 border border-indigo-500 hidden">
                                <span>Next Lecture</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Teacher Bio Modal -->
            <div id="teacher-bio-modal" class="absolute inset-0 bg-slate-800 bg-opacity-75 hidden z-50 transition-opacity duration-300 ease-out p-4 flex items-center justify-center">
                <div id="bio-modal-content" class="bg-slate-700 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md transform scale-95 opacity-0 transition-all duration-300 ease-out border border-amber-300">
                    <div class="flex justify-between items-center mb-5">
                        <h3 id="bio-modal-title" class="text-2xl font-bold text-white">Teacher Bio</h3>
                        <button id="close-bio-modal-btn" class="text-slate-400 hover:text-slate-200 text-4xl font-light leading-none transition-transform duration-200 hover:rotate-90">&times;</button>
                    </div>
                    <div id="bio-content">
                        <img id="bio-teacher-picture" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-amber-400 object-cover">
                        <h4 id="bio-teacher-name" class="text-xl font-bold text-center text-white mb-2"></h4>
                        <p id="bio-teacher-details" class="text-slate-300 text-center"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Footer -->
    <footer class="bg-slate-800 text-slate-400 text-center p-4">
        <p>&copy; 2024 Lecture Portal. All rights reserved.</p>
    </footer>

    <!-- Policy Footer -->
    <footer class="bg-slate-900 text-slate-500 text-center text-sm p-2 flex justify-center space-x-4">
        <a href="#" class="hover:text-slate-300 transition">Privacy Policy</a>
        <span>|</span>
        <a href="#" class="hover:text-slate-300 transition">Terms of Service</a>
    </footer>

    <script>
        // !! IMPORTANT: Replace this with the deployed Google Apps Script Web App URL !!
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxRDqBREUsmhFkGZHVQkaRqwsrT8VxiRqCYapG1Ss6CPcbKyD3nKbc1OQP9x3qlPmsF/exec'; // **PLEASE REPLACE THIS**

        const state = {
            portalData: [],
            currentClass: null,
            currentTeacher: null,
            currentSubject: null,
            currentLecture: null,
            favorites: JSON.parse(localStorage.getItem('lectureFavorites')) || [],
            showFavoritesOnly: false
            showFavoritesOnly: false,
            displayedLectures: []
        };

        const DOMElements = {
            app: document.getElementById('app'),
            sections: {
                classes: document.getElementById('classes-section'),
                teachers: document.getElementById('teachers-section'),
                subjects: document.getElementById('subjects-section'),
                lectures: document.getElementById('lectures-section'),
            },
            containers: {
                classes: document.getElementById('classes-container'),
                teachers: document.getElementById('teachers-container'),
                subjects: document.getElementById('subjects-container'),
                lectures: document.getElementById('lectures-container'),
            },
            labels: {
                className: document.getElementById('current-class-name'),
                teacherNameForSubjects: document.getElementById('current-teacher-name-for-subjects'),
                teacherName: document.getElementById('current-teacher-name'),
                subjectName: document.getElementById('current-subject-name'),
            },
            breadcrumbs: {
                home: document.getElementById('breadcrumb-home'),
                class: document.getElementById('breadcrumb-class'),
                teacher: document.getElementById('breadcrumb-teacher'),
                subject: document.getElementById('breadcrumb-subject'),
            },
            modal: {
                main: document.getElementById('lecture-view-modal'),
                content: document.getElementById('modal-content'),
                title: document.getElementById('lecture-modal-title'),
                closeBtn: document.getElementById('close-modal-btn'),
                langEnglishBtn: document.getElementById('lang-english-btn'),
                langUrduBtn: document.getElementById('lang-urdu-btn'),
                videoContainer: document.getElementById('lecture-video-player-container'),
                videoPlayer: null, // Will be assigned dynamically
                audioContainer: document.getElementById('lecture-audio-player-container'),
                audioPlayer: document.getElementById('lecture-audio-player'),
                viewLink: document.getElementById('lecture-view-link'),
                downloadLink: document.getElementById('lecture-download-link'),
                shareBtn: document.getElementById('lecture-share-btn'),
                nextBtn: document.getElementById('lecture-next-btn'),
            },
            bioModal: {
                main: document.getElementById('teacher-bio-modal'),
                content: document.getElementById('bio-modal-content'),
                title: document.getElementById('bio-modal-title'),
                closeBtn: document.getElementById('close-bio-modal-btn'),
                picture: document.getElementById('bio-teacher-picture'),
                name: document.getElementById('bio-teacher-name'),
                details: document.getElementById('bio-teacher-details'),
            },
            search: {
                input: document.getElementById('lecture-search-input'),
                clearBtn: document.getElementById('clear-search-btn'),
                resultCount: document.getElementById('search-result-count'),
                favBtn: document.getElementById('toggle-favorites-btn')
            },
            indicators: {
                loading: document.getElementById('loading-indicator'),
                error: document.getElementById('error-message'),
                urlInstruction: document.getElementById('url-instruction'),
            },
            themeToggle: document.getElementById('theme-toggle')
        };

        function applyTheme(theme) {
            document.body.classList.remove('dark', 'light');
            document.body.classList.add(theme);
            localStorage.setItem('theme', theme);
        }
        
        // Helper function to automatically convert standard YouTube links to the required embed format
        function getEmbedUrl(url) {
            if (!url) return null;
            
            // Regex to identify YouTube Video ID from various URL formats
            // Covers: youtu.be, embed, watch?v=, and shorts
            const youtubeRegex = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(youtubeRegex);

            if (match && match[2].length === 11) {
                return `https://www.youtube.com/embed/${match[2]}`;
            }

            // Return original URL if it's not a recognized YouTube format (e.g., .mp4 file)
            return url;
        }

        // Security: Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        async function fetchData() {
            DOMElements.indicators.loading.classList.remove('hidden');
            DOMElements.indicators.error.classList.add('hidden');
            DOMElements.indicators.urlInstruction.classList.add('hidden');
            try {
                if (!GOOGLE_APPS_SCRIPT_URL || GOOGLE_APPS_SCRIPT_URL.includes('GOOGLE_APPS_SCRIPT_URL_HERE')) {
                    throw new Error("Google Apps Script URL is not set or is the placeholder. Please check the JavaScript file.");
                }
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success' || !result.data) throw new Error(result.message || 'Invalid API response');
                return processData(result.data);
            } catch (error) {
                console.error('Fetch error: Check your Google Apps Script Deployment!', error);
                DOMElements.indicators.error.classList.remove('hidden');
                DOMElements.indicators.urlInstruction.classList.remove('hidden');
                return [];
            } finally {
                DOMElements.indicators.loading.classList.add('hidden');
            }
        }
        
        function processData(rawData) {
            const classesMap = new Map((rawData.classes || []).map(c => [c.id, { ...c, teachers: [] }]));
            const teachersMap = new Map((rawData.teachers || []).map(t => [t.id, { ...t, picture: t.picture || 'https://placehold.co/100x100/475569/cbd5e1?text=N/A', subjects: new Map() }]));
            const lecturesMap = new Map((rawData.lectures || []).map(l => [l.id, l]));

            lecturesMap.forEach(lecture => {
                const teacherObj = teachersMap.get(lecture.teacherId);
                if (teacherObj) {
                    const subjectName = lecture.subject || 'General';
                    if (!teacherObj.subjects.has(subjectName)) {
                        teacherObj.subjects.set(subjectName, { name: subjectName, lectures: [] });
                    }
                    lecture.videoUrl = lecture.videoUrl || '';
                    lecture.videoUrlUrdu = lecture.videoUrlUrdu || '';
                    teacherObj.subjects.get(subjectName).lectures.push({ ...lecture, number: parseInt(lecture.number) || 0 });
                }
            });

            teachersMap.forEach(teacher => {
                teacher.subjects = Array.from(teacher.subjects.values()).sort((a, b) => a.name.localeCompare(b.name));
                teacher.subjects.forEach(subject => subject.lectures.sort((a, b) => a.number - b.number));
            });

            teachersMap.forEach(teacher => {
                if (teacher.classId && Array.isArray(teacher.classId)) {
                    teacher.classId.forEach(cId => {
                        const classObj = classesMap.get(cId);
                        if (classObj) {
                            if (!classObj.teachers.some(t => t.id === teacher.id)) {
                                classObj.teachers.push(teacher);
                            }
                        }
                    });
                }
            });

            classesMap.forEach(classObj => {
                classObj.teachers.sort((a, b) => a.name.localeCompare(b.name));
            });

            return Array.from(classesMap.values());
        }

        function renderClasses() {
            const container = DOMElements.containers.classes;
            container.innerHTML = state.portalData.map(cls => `
                <div class="card-hover card-class p-6 rounded-xl shadow-md flex flex-col justify-between border border-slate-500 class-card-min-h" data-id="${cls.id}">
                    <div><h3 class="text-white text-xl font-semibold mb-2">${escapeHtml(cls.name)}</h3><p class="text-slate-300 text-sm">${cls.teachers.length} Teachers</p></div>
                    <button class="mt-4 bg-amber-500 text-white px-5 py-2 rounded-lg font-semibold hover:bg-amber-600 transition">View Teachers</button>
                </div>`).join('') || '<p class="text-slate-300 text-center col-span-full py-8 text-lg">No classes available.</p>';
            showSection('classes');
        }

        function renderTeachers(cls) {
            state.currentClass = cls;
            DOMElements.labels.className.textContent = cls.name;
            const container = DOMElements.containers.teachers;
            container.innerHTML = cls.teachers.map(t => `
                <div class="card-hover card-teacher p-6 rounded-xl shadow-md flex flex-col items-center text-center border border-slate-500 teacher-card-min-h" data-id="${t.id}" id="teacher-card-${t.id}">
                    <img src="${t.picture}" alt="${escapeHtml(t.name)}" class="w-24 h-24 rounded-full object-cover mb-4 border-4 border-amber-400" onerror="this.src='https://placehold.co/100x100/475569/cbd5e1?text=N/A'">
                    <h3 class="text-white text-xl font-semibold mb-1">${escapeHtml(t.name)}</h3><p class="text-slate-300 text-sm">${t.subjects.length} Subjects</p>
                    <div class="mt-4 flex gap-2 w-full">
                        <button class="flex-1 bg-amber-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-amber-600 transition view-subjects-btn">View Subjects</button>
                        <button class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-blue-600 transition view-bio-btn">Bio</button>
                    </div>
                </div>`).join('') || '<p class="text-slate-300 text-center col-span-full py-8 text-lg">No teachers for this class.</p>';
            showSection('teachers');
        }
        
        function renderSubjects(teacher) {
            state.currentTeacher = teacher;
            DOMElements.labels.teacherNameForSubjects.textContent = teacher.name;
            const container = DOMElements.containers.subjects;
            container.innerHTML = teacher.subjects.map(s => `
                <div class="card-hover card-subject p-6 rounded-xl shadow-md flex flex-col justify-between border border-slate-500 subject-card-min-h" data-id="${escapeHtml(s.name)}">
                    <div><h3 class="text-white text-xl font-semibold mb-2">${escapeHtml(s.name)}</h3><p class="text-slate-300 text-sm">${s.lectures.length} Lectures</p></div>
                    <button class="mt-4 bg-amber-500 text-white px-5 py-2 rounded-lg font-semibold hover:bg-amber-600 transition">View Lectures</button>
                </div>`).join('') || '<p class="text-slate-300 text-center col-span-full py-8 text-lg">No subjects for this teacher.</p>';
            showSection('subjects');
        }

        function renderLectures(subject, searchQuery = '') {
            state.currentSubject = subject;
            DOMElements.labels.subjectName.textContent = subject.name;
            DOMElements.labels.teacherName.textContent = state.currentTeacher.name;
            
            let lectures = subject.lectures;

            // Filter by Favorites
            if (state.showFavoritesOnly) {
                lectures = lectures.filter(l => state.favorites.includes(l.id));
            }

            const lowerCaseQuery = searchQuery.toLowerCase();
            if (searchQuery) {
                lectures = lectures.filter(l => 
                    l.title.toLowerCase().includes(lowerCaseQuery) || 
                    String(l.number).toLowerCase().includes(lowerCaseQuery) ||
                    (l.contentUrl && l.contentUrl.toLowerCase().includes(lowerCaseQuery))
                );
            }

            state.displayedLectures = lectures;
            
            DOMElements.search.resultCount.textContent = `${lectures.length} lectures found.`;
            
            const container = DOMElements.containers.lectures;
            container.innerHTML = lectures.map(l => {
                const isFav = state.favorites.includes(l.id);
                const heartFill = isFav ? "currentColor" : "none";
                const heartColor = isFav ? "text-red-500" : "text-slate-400";
                
                // Highlight Logic
                let titleHtml = escapeHtml(l.title);
                if (searchQuery) {
                    const regex = new RegExp(`(${searchQuery})`, 'gi');
                    titleHtml = titleHtml.replace(regex, '<span class="highlight-text">$1</span>');
                }

                return `
                <div class="card-hover card-lecture p-6 rounded-xl shadow-md flex items-center justify-between border border-slate-500 lecture-card-min-h" data-id="${l.id}">
                    <div class="flex items-center space-x-4">
                        <div class="flex flex-col items-center gap-2">
                            <svg class="book-icon w-8 h-8 text-amber-400" fill="currentColor" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9 4h2v5H9V4zm4 16h-2v-5h2v5zm4-16h-2v5h2V4z"></path></svg>
                            <button class="fav-btn p-1 rounded-full hover:bg-slate-700/50 transition" title="${isFav ? 'Remove from Favorites' : 'Add to Favorites'}">
                                <svg class="w-6 h-6 ${heartColor} transition-colors duration-300" fill="${heartFill}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            </button>
                        </div>
                        <div>
                            <h3 class="text-white text-lg font-semibold">${titleHtml}</h3>
                            <p class="text-slate-300 text-sm">Lecture ${l.number}</p>
                        </div>
                    </div>
                    <button class="mt-0 bg-amber-500 text-white px-5 py-2 rounded-lg font-semibold hover:bg-amber-600 transition view-lecture-btn">View</button>
                </div>`;
            }).join('') || `<p class="text-slate-300 text-center col-span-full py-8 text-lg">No lectures found.</p>`;
            showSection('lectures');
        }
        
        function showSection(sectionName) {
            Object.values(DOMElements.sections).forEach(s => s.classList.add('hidden'));
            const section = DOMElements.sections[sectionName];
            section.classList.remove('hidden');
            section.classList.add('section-fade-in');
            section.onanimationend = () => section.classList.remove('section-fade-in');
            
            hideModal(true);
            if (sectionName !== 'lectures') {
                DOMElements.search.input.value = '';
                state.showFavoritesOnly = false;
                updateFavBtnState();
            }
            updateBreadcrumbs();
        }

        function updateBreadcrumbs() {
            const { home, class: cls, teacher, subject } = DOMElements.breadcrumbs;

            [home, cls.querySelector('span:last-child'), teacher.querySelector('span:last-child'), subject.querySelector('span:last-child')].forEach(el => {
                el.classList.remove('active-breadcrumb');
            });
            
            cls.classList.toggle('hidden', !state.currentClass);
            if (state.currentClass) cls.querySelector('span:last-child').textContent = state.currentClass.name;
            
            teacher.classList.toggle('hidden', !state.currentTeacher);
            if (state.currentTeacher) teacher.querySelector('span:last-child').textContent = state.currentTeacher.name;
            
            subject.classList.toggle('hidden', !state.currentSubject);
            if (state.currentSubject) subject.querySelector('span:last-child').textContent = state.currentSubject.name;

            if (state.currentSubject) {
                subject.querySelector('span:last-child').classList.add('active-breadcrumb');
            } else if (state.currentTeacher) {
                teacher.querySelector('span:last-child').classList.add('active-breadcrumb');
            } else if (state.currentClass) {
                cls.querySelector('span:last-child').classList.add('active-breadcrumb');
            } else {
                home.classList.add('active-breadcrumb');
            }
        }

        function updateModalContent(lang) {
            if (!state.currentLecture) return;
            const l = state.currentLecture;
            const isUrdu = lang === 'urdu';
            
            const videoUrlRaw = isUrdu ? l.videoUrlUrdu || l.videoUrl : l.videoUrl;
            const normalizedVideoUrl = getEmbedUrl(videoUrlRaw);

            const contentUrl = isUrdu ? l.contentUrlUrdu || l.contentUrl : l.contentUrl;
            const downloadUrl = isUrdu ? l.downloadUrlUrdu || l.downloadUrl : l.downloadUrl;
            const audioUrl = isUrdu ? l.audioUrlUrdu || l.audioUrl : l.audioUrl;
            
            const videoContainer = DOMElements.modal.videoContainer;
            const audioPlayer = DOMElements.modal.audioPlayer;
            const audioContainer = DOMElements.modal.audioContainer;

            // 1. Handle Audio Player
            audioPlayer.src = audioUrl || '';
            audioPlayer.pause();
            audioContainer.classList.toggle('hidden', !audioUrl);

            // 2. Handle Video/YouTube Player
            if (normalizedVideoUrl) {
                const isYouTube = normalizedVideoUrl.includes('youtube.com/embed');
                
                if (isYouTube) {
                    videoContainer.innerHTML = `
                        <p class="text-slate-300 mb-2 font-semibold px-2 pt-2">Lecture Video (YouTube):</p>
                        <iframe 
                            class="absolute top-0 left-0 w-full h-full"
                            src="${normalizedVideoUrl}" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            loading="lazy"
                        ></iframe>
                    `;
                    DOMElements.modal.videoPlayer = null;
                } else {
                    videoContainer.innerHTML = `
                        <p class="text-slate-300 mb-2 font-semibold px-2 pt-2">Lecture Video (Direct Media):</p>
                        <video id="lecture-video-player-native" controls preload="metadata" class="w-full h-full absolute top-0 left-0 object-contain bg-black"></video>
                    `;
                    const nativePlayer = document.getElementById('lecture-video-player-native');
                    if (nativePlayer) {
                        nativePlayer.src = normalizedVideoUrl;
                        DOMElements.modal.videoPlayer = nativePlayer; 
                    }
                }
                videoContainer.classList.remove('hidden');
            } else {
                if(DOMElements.modal.videoPlayer) DOMElements.modal.videoPlayer.pause();
                videoContainer.classList.add('hidden');
                videoContainer.innerHTML = '';
                DOMElements.modal.videoPlayer = null;
            }

            // 3. Update Links and Styles
            const viewLink = DOMElements.modal.viewLink;
            const downloadLink = DOMElements.modal.downloadLink;

            viewLink.href = contentUrl || '#';
            viewLink.classList.toggle('btn-disabled', !contentUrl);
            viewLink.style.pointerEvents = contentUrl ? 'auto' : 'none';

            downloadLink.href = downloadUrl || '#';
            downloadLink.download = downloadUrl ? `${l.title.replace(/\s/g, '_')}_${lang}.pdf` : null;
            downloadLink.classList.toggle('btn-disabled', !downloadUrl);
            downloadLink.style.pointerEvents = downloadUrl ? 'auto' : 'none';
            
            DOMElements.modal.langEnglishBtn.classList.toggle('ring-2', !isUrdu);
            DOMElements.modal.langUrduBtn.classList.toggle('ring-2', isUrdu);

            // Share Button Logic
            DOMElements.modal.shareBtn.onclick = () => {
                const shareData = {
                    title: `Lecture: ${l.title}`,
                    text: `Check out this lecture: ${l.title}`,
                    url: window.location.href // In a real app, this would be a deep link
                };
                if (navigator.share) {
                    navigator.share(shareData).catch(console.error);
                } else {
                    navigator.clipboard.writeText(`${l.title} - ${l.videoUrl || l.contentUrl}`);
                    showToast('Lecture link copied to clipboard!');
                }
            };
        }

        function updateNextButtonVisibility() {
            const btn = DOMElements.modal.nextBtn;
            if (!state.currentLecture || !state.displayedLectures.length) {
                btn.classList.add('hidden');
                return;
            }
            const currentIndex = state.displayedLectures.findIndex(l => l.id === state.currentLecture.id);
            if (currentIndex !== -1 && currentIndex < state.displayedLectures.length - 1) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        function loadNextLecture() {
            const currentIndex = state.displayedLectures.findIndex(l => l.id === state.currentLecture.id);
            if (currentIndex !== -1 && currentIndex < state.displayedLectures.length - 1) {
                showModal(state.displayedLectures[currentIndex + 1]);
            }
        }

        function showModal(lecture, event) {
            state.currentLecture = lecture;
            DOMElements.modal.title.textContent = `Lecture ${lecture.number}: ${lecture.title}`;
            updateModalContent('english');
            
            DOMElements.modal.main.classList.remove('hidden');
            // Scroll to top to ensure visibility
            DOMElements.modal.main.scrollTop = 0;
            
            setTimeout(() => {
                const modalContent = DOMElements.modal.content;
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 10);

            updateNextButtonVisibility();
        }

        function hideModal(immediate = false) {
            DOMElements.modal.audioPlayer.pause();
            if (DOMElements.modal.videoPlayer) DOMElements.modal.videoPlayer.pause();
            
            const modalContent = DOMElements.modal.content;
            
            if (immediate) {
                DOMElements.modal.main.classList.add('hidden');
            } else {
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    DOMElements.modal.main.classList.add('hidden');
                }, 300);
            }
        }
        
        function showBioModal(teacher) {
            const bioCard = document.getElementById(`teacher-card-${teacher.id}`);
            if (bioCard) {
                bioCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            DOMElements.bioModal.picture.src = teacher.picture;
            DOMElements.bioModal.name.textContent = teacher.name;
            
            const bioText = teacher.bio || 'No bio available.';
            const email = teacher.email ? `Email: ${teacher.email}` : '';
            const phone = teacher.phone ? `Phone: ${teacher.phone}` : '';
            
            DOMElements.bioModal.details.innerHTML = `
                <p class="mb-2">${escapeHtml(bioText)}</p>
                <p class="font-semibold">${escapeHtml(email)}</p>
                <p class="font-semibold">${escapeHtml(phone)}</p>
            `;

            DOMElements.bioModal.main.classList.remove('hidden');
            setTimeout(() => {
                DOMElements.bioModal.content.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideBioModal(immediate = false) {
            const bioContent = DOMElements.bioModal.content;
            
            if (immediate) {
                DOMElements.bioModal.main.classList.add('hidden');
            } else {
                bioContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    DOMElements.bioModal.main.classList.add('hidden');
                }, 300);
            }
        }

        function updateFavBtnState() {
            const btn = DOMElements.search.favBtn;
            const textSpan = document.getElementById('fav-btn-text');
            if (state.showFavoritesOnly) {
                btn.classList.add('bg-amber-600', 'border-amber-400');
                btn.classList.remove('bg-slate-700', 'border-slate-500');
                textSpan.textContent = "Show All";
            } else {
                btn.classList.remove('bg-amber-600', 'border-amber-400');
                btn.classList.add('bg-slate-700', 'border-slate-500');
                textSpan.textContent = "Favorites";
            }
        }

        function setupEventListeners() {
            // Event Delegation
            Object.values(DOMElements.containers).forEach(container => {
                container.addEventListener('click', (e) => {
                    const card = e.target.closest('[data-id]');
                    if (!card) return;
                    const id = card.dataset.id;

                    // Handle Favorite Button Click
                    const favBtn = e.target.closest('.fav-btn');
                    if (favBtn) {
                        const index = state.favorites.indexOf(id);
                        if (index === -1) {
                            state.favorites.push(id);
                            showToast('Added to Favorites');
                        } else {
                            state.favorites.splice(index, 1);
                            showToast('Removed from Favorites');
                        }
                        localStorage.setItem('lectureFavorites', JSON.stringify(state.favorites));
                        renderLectures(state.currentSubject, DOMElements.search.input.value);
                        return;
                    }

                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    switch(container.id) {
                        case 'classes-container':
                            const cls = state.portalData.find(c => c.id === id);
                            if (cls) renderTeachers(cls);
                            break;
                        case 'teachers-container':
                            const teacher = state.currentClass.teachers.find(t => t.id === id);
                            if (button.classList.contains('view-subjects-btn')) {
                                if (teacher) renderSubjects(teacher);
                            } else if (button.classList.contains('view-bio-btn')) {
                                if (teacher) {
                                    const teacherCard = document.getElementById(`teacher-card-${teacher.id}`);
                                    if(teacherCard) {
                                        teacherCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        setTimeout(() => showBioModal(teacher), 500);
                                    } else {
                                        showBioModal(teacher);
                                    }
                                }
                            }
                            break;
                        case 'subjects-container':
                           const subject = state.currentTeacher.subjects.find(s => s.name === id);
                           if (subject) renderLectures(subject);
                            break;
                        case 'lectures-container':
                            const lecture = state.currentSubject.lectures.find(l => l.id === id);
                            if (lecture) showModal(lecture, e);
                            break;
                    }
                });
            });

            // Modal
            DOMElements.modal.closeBtn.addEventListener('click', () => hideModal());
            DOMElements.modal.main.addEventListener('click', (e) => { 
                // Close if clicking the backdrop (wrapper)
                if (e.target.classList.contains('modal-scroll-wrapper')) hideModal();
            });
            DOMElements.modal.langEnglishBtn.addEventListener('click', () => updateModalContent('english'));
            DOMElements.modal.langUrduBtn.addEventListener('click', () => updateModalContent('urdu'));

            // Next Lecture Button
            DOMElements.modal.nextBtn.addEventListener('click', loadNextLecture);

            // Bio Modal
            DOMElements.bioModal.closeBtn.addEventListener('click', () => hideBioModal());
            DOMElements.bioModal.main.addEventListener('click', (e) => {
                // Fix: Check against bioModal.main
                if (e.target === DOMElements.bioModal.main) hideBioModal();
            });

            // Search
            DOMElements.search.input.addEventListener('keyup', e => renderLectures(state.currentSubject, e.target.value));
            DOMElements.search.clearBtn.addEventListener('click', () => {
                DOMElements.search.input.value = '';
                renderLectures(state.currentSubject);
            });
            
            // Favorites Toggle
            DOMElements.search.favBtn.addEventListener('click', () => {
                state.showFavoritesOnly = !state.showFavoritesOnly;
                updateFavBtnState();
                renderLectures(state.currentSubject, DOMElements.search.input.value);
            });

            // Breadcrumbs
            DOMElements.breadcrumbs.home.addEventListener('click', () => { state.currentClass = state.currentTeacher = state.currentSubject = null; renderClasses(); });
            DOMElements.breadcrumbs.class.querySelector('span:last-child').addEventListener('click', () => { state.currentTeacher = state.currentSubject = null; renderTeachers(state.currentClass); });
            DOMElements.breadcrumbs.teacher.querySelector('span:last-child').addEventListener('click', () => { state.currentSubject = null; renderSubjects(state.currentTeacher); });

            // Theme Toggle
            DOMElements.themeToggle.addEventListener('click', () => {
                const currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            setupEventListeners();
            state.portalData = await fetchData();
            if (state.portalData.length > 0) {
                renderClasses();
            }
        });
    </script>
</body>
</html>
